<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeShare 3D - AI Guarded Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons script -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-[#020617] text-slate-100 min-h-screen">

    <!-- Navigation -->
    <nav class="sticky top-0 z-40 bg-slate-900/50 backdrop-blur-xl border-b border-white/5 px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-500 p-2 rounded-xl shadow-lg shadow-indigo-500/20">
                <i data-lucide="rotate-3d" class="text-white w-6 h-6"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight">CodeShare 3D</h1>
        </div>
        <button id="openEditorBtn" class="flex items-center gap-2 bg-indigo-500 hover:bg-indigo-400 text-white px-5 py-2.5 rounded-full font-bold transition-all shadow-lg shadow-indigo-500/10 active:scale-95">
            <i data-lucide="plus" class="w-5 h-5"></i>
            <span>新規投稿</span>
        </button>
    </nav>

    <!-- Main Content -->
    <main class="max-w-5xl mx-auto p-6">
        <div class="mb-8 text-center">
            <h2 class="text-2xl font-bold mb-2">作品タイムライン</h2>
            <p class="text-slate-500 text-sm">AIによって認証されたCodeShare 3Dの作品集</p>
        </div>
        <div id="postsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Posts will be injected here -->
            <div id="loadingState" class="col-span-full py-32 text-center border-2 border-dashed border-white/5 rounded-3xl">
                <i data-lucide="loader-2" class="w-16 h-16 text-slate-800 mx-auto mb-4 animate-spin"></i>
                <p class="text-slate-500">作品を読み込み中...</p>
            </div>
        </div>
    </main>

    <!-- Editor Modal (Hidden by default) -->
    <div id="editorModal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center p-0 sm:p-4 hidden">
        <div class="bg-slate-900 w-full max-w-7xl h-full sm:h-[90vh] sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-white/10">
            <!-- Modal Header -->
            <div class="p-4 border-b border-white/5 flex items-center justify-between bg-slate-900/80">
                <input id="postTitle" type="text" placeholder="作品タイトルを入力..." class="bg-transparent text-xl font-bold outline-none flex-1 px-4 placeholder:text-slate-600 focus:text-indigo-400 transition-colors">
                <div class="flex items-center gap-3">
                    <div id="aiValidatingLabel" class="hidden md:flex items-center gap-2 text-indigo-400 text-sm font-bold bg-indigo-400/10 px-4 py-2 rounded-full border border-indigo-400/20">
                        <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                        AI検証中...
                    </div>
                    <button id="closeEditorBtn" class="p-2 text-slate-400 hover:text-white hover:bg-white/5 rounded-full">
                        <i data-lucide="x"></i>
                    </button>
                    <button id="submitPostBtn" class="bg-indigo-500 hover:bg-indigo-400 disabled:opacity-30 disabled:cursor-not-allowed text-white px-8 py-2.5 rounded-full font-bold transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-4 h-4" id="submitBtnIcon"></i>
                        <span id="submitBtnText">AIチェック & 投稿</span>
                    </button>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="bg-rose-500/10 border-b border-rose-500/30 p-4 flex items-center gap-3 text-rose-400 text-sm px-8 hidden animate-in">
                <i data-lucide="alert-circle" class="w-5 h-5 shrink-0"></i>
                <span id="errorText" class="font-medium text-xs"></span>
            </div>

            <!-- Editor Body -->
            <div class="flex-1 flex flex-col lg:flex-row overflow-hidden">
                <div class="flex-1 flex flex-col bg-[#0f172a] border-r border-white/5">
                    <div class="px-6 py-3 text-[10px] text-slate-500 font-bold tracking-widest uppercase flex justify-between items-center bg-black/20">
                        <div class="flex items-center gap-2">
                            <i data-lucide="code" class="w-3 h-3"></i>
                            <span>Three.js ソースコード</span>
                        </div>
                        <button id="refreshPreviewBtn" class="text-indigo-400 hover:text-white transition-colors">更新</button>
                    </div>
                    <textarea id="codeEditor" class="flex-1 w-full bg-transparent text-indigo-300 p-6 font-mono text-sm outline-none resize-none selection:bg-indigo-500/30" spellcheck="false"></textarea>
                </div>
                <div class="flex-1 bg-black relative">
                    <div class="absolute top-4 left-4 z-10 bg-black/50 backdrop-blur-md px-3 py-1 rounded-md border border-white/10 text-[10px] font-bold text-white/50 pointer-events-none uppercase">プレビュー</div>
                    <iframe id="editorPreview" class="w-full h-full border-none" sandbox="allow-scripts"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Configuration & Initialization ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'codeshare-ai-3d';
        const apiKey = ""; // Provided by env

        let currentUser = null;
        const THREE_TEMPLATE = `<!DOCTYPE html>
<html>
<head>
    <style>body { margin: 0; overflow: hidden; background: #020617; } canvas { width: 100vw; height: 100vh; display: block; }</style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
        const material = new THREE.MeshPhongMaterial({ color: 0x818cf8, shininess: 100 });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);
        const light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(10, 10, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x1e293b));
        camera.position.z = 4;
        function animate() { requestAnimationFrame(animate); mesh.rotation.x += 0.01; mesh.rotation.y += 0.01; renderer.render(scene, camera); }
        animate();
        window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    <\/script>
</body>
</html>`;

        // --- Elements ---
        const openEditorBtn = document.getElementById('openEditorBtn');
        const closeEditorBtn = document.getElementById('closeEditorBtn');
        const editorModal = document.getElementById('editorModal');
        const postTitle = document.getElementById('postTitle');
        const codeEditor = document.getElementById('codeEditor');
        const editorPreview = document.getElementById('editorPreview');
        const refreshPreviewBtn = document.getElementById('refreshPreviewBtn');
        const submitPostBtn = document.getElementById('submitPostBtn');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const postsGrid = document.getElementById('postsGrid');
        const aiValidatingLabel = document.getElementById('aiValidatingLabel');

        // Safety wrapper for lucide.createIcons
        const refreshIcons = () => {
            if (window.lucide) {
                window.lucide.createIcons();
            } else {
                console.warn('Lucide not loaded yet');
            }
        };

        // --- Authentication ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth Error", e);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) loadPosts();
        });

        // --- Functions ---
        const loadPosts = () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'posts'));
            onSnapshot(q, (snapshot) => {
                const posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                posts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                window._currentPosts = posts; // Store for simple rerenders
                renderPosts(posts);
            }, err => console.error(err));
        };

        const renderPosts = (posts) => {
            if (posts.length === 0) {
                postsGrid.innerHTML = `
                    <div class="col-span-full py-32 text-center border-2 border-dashed border-white/5 rounded-3xl">
                        <i data-lucide="box" class="w-16 h-16 text-slate-800 mx-auto mb-4"></i>
                        <p class="text-slate-500">まだ投稿がありません。</p>
                    </div>`;
            } else {
                postsGrid.innerHTML = posts.map(post => `
                    <div class="bg-slate-900/40 rounded-3xl overflow-hidden border border-white/5 group hover:border-indigo-500/30 transition-all shadow-xl animate-in">
                        <div class="aspect-video relative bg-black">
                            <div id="canvas-container-${post.id}" class="w-full h-full flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 to-black">
                                <div class="w-16 h-16 rounded-2xl bg-indigo-500/10 flex items-center justify-center mb-4 border border-indigo-500/20 group-hover:scale-110 transition-transform duration-500">
                                    <i data-lucide="rotate-3d" class="text-indigo-400 w-8 h-8"></i>
                                </div>
                                <button onclick="window.playPost('${post.id}')" class="bg-white/10 backdrop-blur-md border border-white/10 text-white px-8 py-3 rounded-full font-bold flex items-center gap-3 hover:bg-white/20 transition-all shadow-2xl active:scale-95">
                                    <i data-lucide="play" class="w-4 h-4 fill-current"></i> 
                                    <span>3Dシーンを起動</span>
                                </button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1 min-w-0 pr-4">
                                    <h3 class="text-lg font-bold truncate group-hover:text-indigo-400 transition-colors">${post.title}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-xs text-slate-500">@${post.authorName || 'User'}</span>
                                        <span class="w-1 h-1 rounded-full bg-slate-700"></span>
                                        <span class="text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded-full font-bold border border-emerald-500/20 uppercase">AI Verified</span>
                                    </div>
                                </div>
                                <button onclick="window.handleLike('${post.id}')" class="flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-full hover:bg-rose-500/10 hover:text-rose-500 transition-all border border-transparent hover:border-rose-500/20">
                                    <i data-lucide="heart" class="w-4 h-4 ${post.likes > 0 ? 'fill-rose-500 text-rose-500' : 'text-slate-500'}"></i>
                                    <span class="font-bold text-sm">${post.likes || 0}</span>
                                </button>
                            </div>
                            <div class="flex items-center justify-between pt-4 border-t border-white/5">
                                <div class="flex items-center gap-2">
                                    <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                                    <span class="text-[10px] font-mono text-slate-600 uppercase tracking-widest">Type: CodeShare 3D JSON</span>
                                </div>
                                <button class="text-slate-600 hover:text-indigo-400"><i data-lucide="share-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            refreshIcons();
            window._postCodes = posts.reduce((acc, p) => ({...acc, [p.id]: p.content?.code || p.code}), {});
        };
        window.renderPosts = renderPosts;

        window.playPost = (id) => {
            const container = document.getElementById(`canvas-container-${id}`);
            const code = window._postCodes[id];
            container.innerHTML = `
                <iframe srcdoc="${code.replace(/"/g, '&quot;')}" class="w-full h-full border-none" sandbox="allow-scripts"></iframe>
                <button onclick="window.renderPosts(window._currentPosts)" class="absolute top-4 right-4 z-20 bg-black/60 hover:bg-rose-500 p-2 rounded-full text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            refreshIcons();
        };

        window.handleLike = async (id) => {
            if (!currentUser) return;
            const ref = doc(db, 'artifacts', appId, 'public', 'data', 'posts', id);
            await updateDoc(ref, { likes: increment(1) });
        };

        const validateWithAI = async (codeSnippet) => {
            const systemPrompt = "You are a specialized code validator. Your task is to analyze if the provided code is a valid HTML/JavaScript 3D model using Three.js. Respond ONLY in a structured JSON format.";
            const userQuery = `Analyze this code and determine if it creates a 3D scene using Three.js. Code: ${codeSnippet} Return JSON: { "is3D": boolean, "reason": "string", "confidence": number }`;

            const retryFetch = async (retries = 5, delay = 1000) => {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { 
                                responseMimeType: "application/json", 
                                responseSchema: { 
                                    type: "OBJECT", 
                                    properties: { 
                                        is3D: { type: "boolean" },
                                        reason: { type: "string" },
                                        confidence: { type: "number" }
                                    },
                                    required: ["is3D", "reason", "confidence"]
                                } 
                            }
                        })
                    });
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (err) {
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, delay));
                        return retryFetch(retries - 1, delay * 2);
                    }
                    throw err;
                }
            };
            return await retryFetch();
        };

        // --- Event Listeners ---
        openEditorBtn.onclick = () => {
            editorModal.classList.remove('hidden');
            codeEditor.value = THREE_TEMPLATE;
            editorPreview.srcdoc = THREE_TEMPLATE;
            refreshIcons();
        };

        closeEditorBtn.onclick = () => {
            editorModal.classList.add('hidden');
            errorMessage.classList.add('hidden');
        };

        refreshPreviewBtn.onclick = () => {
            editorPreview.srcdoc = codeEditor.value;
        };

        submitPostBtn.onclick = async () => {
            const title = postTitle.value.trim();
            const code = codeEditor.value.trim();
            if (!title || !currentUser) return;

            submitPostBtn.disabled = true;
            aiValidatingLabel.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            document.getElementById('submitBtnText').innerText = '検証中...';

            try {
                const result = await validateWithAI(code);
                if (!result.is3D) {
                    throw new Error(`AI判定: 3Dモデルとして承認されませんでした。理由: ${result.reason}`);
                }

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
                    title,
                    content: { code, type: 'threejs', aiScore: result.confidence },
                    userId: currentUser.uid,
                    likes: 0,
                    createdAt: Date.now(),
                    authorName: `Creator-${currentUser.uid.slice(0, 5)}`
                });

                editorModal.classList.add('hidden');
                postTitle.value = '';
            } catch (err) {
                errorMessage.classList.remove('hidden');
                errorText.innerText = err.message;
            } finally {
                submitPostBtn.disabled = false;
                aiValidatingLabel.classList.add('hidden');
                document.getElementById('submitBtnText').innerText = 'AIチェック & 投稿';
                refreshIcons();
            }
        };

        // Window Load handling for Lucide
        window.addEventListener('load', () => {
            initAuth().catch(console.error);
            refreshIcons();
        });
        
        // Immediate check in case load already fired
        if (document.readyState === 'complete') {
            refreshIcons();
        }
    </script>
</body>
</html>
