import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  query, 
  onSnapshot, 
  doc, 
  updateDoc, 
  increment 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  Code, 
  Play, 
  Share2, 
  Heart, 
  User, 
  Plus, 
  Box, 
  X,
  Rotate3d,
  Layers,
  ShieldCheck,
  Loader2,
  AlertCircle
} from 'lucide-react';

// --- Firebase & API Setup ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'codeshare-ai-3d';
const apiKey = ""; // API key is provided by the execution environment at runtime

// --- Default 3D Template ---
const THREE_TEMPLATE = `<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin: 0; overflow: hidden; background: #020617; }
        canvas { width: 100vw; height: 100vh; display: block; }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const geometry = new THREE.TorusKnotGeometry(1, 0.3, 100, 16);
        const material = new THREE.MeshPhongMaterial({ color: 0x818cf8, shininess: 100 });
        const mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        const light = new THREE.PointLight(0xffffff, 1, 100);
        light.position.set(10, 10, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x1e293b));

        camera.position.z = 4;

        function animate() {
            requestAnimationFrame(animate);
            mesh.rotation.x += 0.01;
            mesh.rotation.y += 0.01;
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>`;

export default function App() {
  const [user, setUser] = useState(null);
  const [posts, setPosts] = useState([]);
  const [isEditorOpen, setIsEditorOpen] = useState(false);
  const [isValidating, setIsValidating] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  
  // Editor State
  const [title, setTitle] = useState('');
  const [code, setCode] = useState(THREE_TEMPLATE);
  const [previewKey, setPreviewKey] = useState(0);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth init error:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const publicCollection = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
    const q = query(publicCollection);
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const fetchedPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const sortedPosts = fetchedPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      setPosts(sortedPosts);
    }, (error) => console.error("Firestore error:", error));
    return () => unsubscribe();
  }, [user]);

  // AI Validation with Gemini
  const validateWithAI = async (codeSnippet) => {
    const systemPrompt = "You are a specialized code validator. Your task is to analyze if the provided code is a valid HTML/JavaScript 3D model using Three.js. Respond ONLY in a structured JSON format.";
    const userQuery = `Analyze this code and determine if it creates a 3D scene using Three.js.
    Code: ${codeSnippet}
    Return JSON: { "is3D": boolean, "reason": "string", "confidence": number }`;

    const retryFetch = async (retries = 5, delay = 1000) => {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { 
              responseMimeType: "application/json", 
              responseSchema: { 
                type: "OBJECT", 
                properties: { 
                  is3D: { type: "boolean" },
                  reason: { type: "string" },
                  confidence: { type: "number" }
                },
                required: ["is3D", "reason", "confidence"]
              } 
            }
          })
        });
        
        if (!response.ok) {
          const errData = await response.json().catch(() => ({}));
          throw new Error(`API Error: ${response.status} ${errData.error?.message || ''}`);
        }
        
        const data = await response.json();
        const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!textResponse) throw new Error('Empty AI response');
        return JSON.parse(textResponse);
      } catch (err) {
        if (retries > 0) {
          await new Promise(r => setTimeout(r, delay));
          return retryFetch(retries - 1, delay * 2);
        }
        throw err;
      }
    };
    return await retryFetch();
  };

  const handlePost = async () => {
    if (!user || !title.trim() || isValidating) return;
    
    setIsValidating(true);
    setErrorMessage('');

    try {
      const result = await validateWithAI(code);
      
      if (!result.is3D) {
        setErrorMessage(`AI判定: 3Dモデルとして承認されませんでした。理由: ${result.reason}`);
        setIsValidating(false);
        return;
      }

      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
        title,
        content: {
          code: code,
          type: 'threejs',
          aiScore: result.confidence
        },
        userId: user.uid,
        likes: 0,
        createdAt: Date.now(),
        authorName: `Creator-${user.uid.slice(0, 5)}`
      });
      
      setIsEditorOpen(false);
      setTitle('');
      setCode(THREE_TEMPLATE);
    } catch (err) {
      setErrorMessage(`検証エラー: ${err.message || 'AIサービスに接続できません。'}`);
      console.error("Post processing error:", err);
    } finally {
      setIsValidating(false);
    }
  };

  const handleLike = async (postId) => {
    if (!user) return;
    try {
      const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'posts', postId);
      await updateDoc(postRef, { likes: increment(1) });
    } catch (err) { console.error("Like error:", err); }
  };

  return (
    <div className="min-h-screen bg-[#020617] text-slate-100 font-sans">
      <nav className="sticky top-0 z-40 bg-slate-900/50 backdrop-blur-xl border-b border-white/5 px-6 py-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="bg-indigo-500 p-2 rounded-xl shadow-lg shadow-indigo-500/20">
            <Rotate3d className="text-white w-6 h-6" />
          </div>
          <h1 className="text-xl font-bold tracking-tight">CodeShare 3D</h1>
        </div>
        
        <div className="flex items-center gap-4">
          <button 
            onClick={() => setIsEditorOpen(true)}
            className="flex items-center gap-2 bg-indigo-500 hover:bg-indigo-400 text-white px-5 py-2.5 rounded-full font-bold transition-all shadow-lg shadow-indigo-500/10 active:scale-95"
          >
            <Plus className="w-5 h-5" />
            <span>新規投稿</span>
          </button>
        </div>
      </nav>

      <main className="max-w-5xl mx-auto p-6">
        <div className="mb-8 text-center">
          <h2 className="text-2xl font-bold mb-2">作品タイムライン</h2>
          <p className="text-slate-500 text-sm">AIによって認証されたCodeShare 3Dの作品集</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
          {posts.map(post => (
            <PostCard key={post.id} post={post} onLike={() => handleLike(post.id)} />
          ))}
          {posts.length === 0 && !isValidating && (
             <div className="col-span-full py-32 text-center border-2 border-dashed border-white/5 rounded-3xl">
                <Box className="w-16 h-16 text-slate-800 mx-auto mb-4" />
                <p className="text-slate-500">まだ投稿がありません。最初のCodeShare 3D作品を投稿しましょう。</p>
             </div>
          )}
        </div>
      </main>

      {/* Editor Modal */}
      {isEditorOpen && (
        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-md flex items-center justify-center p-0 sm:p-4">
          <div className="bg-slate-900 w-full max-w-7xl h-full sm:h-[90vh] sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-white/10">
            <div className="p-4 border-b border-white/5 flex items-center justify-between bg-slate-900/80">
              <input 
                type="text" 
                placeholder="CodeShare 3D 作品タイトル..."
                value={title}
                onChange={(e) => setTitle(e.target.value)}
                disabled={isValidating}
                className="bg-transparent text-xl font-bold outline-none flex-1 px-4 placeholder:text-slate-600 focus:text-indigo-400 transition-colors"
              />
              <div className="flex items-center gap-3">
                {isValidating && (
                  <div className="hidden md:flex items-center gap-2 text-indigo-400 text-sm font-bold bg-indigo-400/10 px-4 py-2 rounded-full border border-indigo-400/20">
                    <Loader2 className="w-4 h-4 animate-spin" />
                    AI検証中...
                  </div>
                )}
                <button 
                  onClick={() => {
                    setIsEditorOpen(false);
                    setErrorMessage('');
                  }} 
                  className="p-2 text-slate-400 hover:text-white hover:bg-white/5 rounded-full transition-colors"
                >
                  <X />
                </button>
                <button 
                  onClick={handlePost}
                  disabled={!title.trim() || isValidating}
                  className="bg-indigo-500 hover:bg-indigo-400 disabled:opacity-30 disabled:cursor-not-allowed text-white px-8 py-2.5 rounded-full font-bold transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2"
                >
                  {isValidating ? <Loader2 className="w-4 h-4 animate-spin" /> : <ShieldCheck className="w-4 h-4" />}
                  <span>{isValidating ? '検証中' : 'AIチェック & 投稿'}</span>
                </button>
              </div>
            </div>

            {errorMessage && (
              <div className="bg-rose-500/10 border-b border-rose-500/30 p-4 flex items-center gap-3 text-rose-400 text-sm px-8 animate-in fade-in slide-in-from-top-2">
                <AlertCircle className="w-5 h-5 shrink-0" />
                <span className="font-medium text-xs">{errorMessage}</span>
              </div>
            )}

            <div className="flex-1 flex flex-col lg:flex-row overflow-hidden">
              <div className="flex-1 flex flex-col bg-[#0f172a] border-r border-white/5">
                <div className="px-6 py-3 text-[10px] text-slate-500 font-bold tracking-widest uppercase flex justify-between items-center bg-black/20">
                  <div className="flex items-center gap-2">
                    <Code className="w-3 h-3" />
                    <span>Three.js ソースコード</span>
                  </div>
                  <button 
                    onClick={() => setPreviewKey(k => k + 1)} 
                    className="text-indigo-400 hover:text-white transition-colors"
                  >
                    更新
                  </button>
                </div>
                <textarea 
                  value={code}
                  onChange={(e) => setCode(e.target.value)}
                  disabled={isValidating}
                  className="flex-1 w-full bg-transparent text-indigo-300 p-6 font-mono text-sm outline-none resize-none selection:bg-indigo-500/30"
                  spellCheck="false"
                />
              </div>
              
              <div className="flex-1 bg-black relative">
                 <div className="absolute top-4 left-4 z-10 bg-black/50 backdrop-blur-md px-3 py-1 rounded-md border border-white/10 text-[10px] font-bold text-white/50 pointer-events-none uppercase">
                   プレビュー
                 </div>
                <iframe 
                  key={previewKey} 
                  srcDoc={code} 
                  className="w-full h-full border-none" 
                  sandbox="allow-scripts" 
                />
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function PostCard({ post, onLike }) {
  const [isPlaying, setIsPlaying] = useState(false);
  const code = post.content?.code || post.code;

  return (
    <div className="bg-slate-900/40 rounded-3xl overflow-hidden border border-white/5 group hover:border-indigo-500/30 transition-all shadow-xl">
      <div className="aspect-video relative bg-black group-hover:shadow-inner">
        {isPlaying ? (
          <iframe 
            srcDoc={code} 
            className="w-full h-full border-none" 
            sandbox="allow-scripts" 
            loading="lazy"
          />
        ) : (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-slate-900 to-black">
             <div className="w-16 h-16 rounded-2xl bg-indigo-500/10 flex items-center justify-center mb-4 border border-indigo-500/20 group-hover:scale-110 transition-transform duration-500">
               <Rotate3d className="text-indigo-400 w-8 h-8" />
             </div>
             <button 
                onClick={() => setIsPlaying(true)}
                className="bg-white/10 backdrop-blur-md border border-white/10 text-white px-8 py-3 rounded-full font-bold flex items-center gap-3 hover:bg-white/20 transition-all shadow-2xl active:scale-95"
              >
                <Play className="w-4 h-4 fill-current" /> 
                <span>3Dシーンを起動</span>
              </button>
          </div>
        )}
        {isPlaying && (
          <button 
            onClick={() => setIsPlaying(false)}
            className="absolute top-4 right-4 z-20 bg-black/60 hover:bg-rose-500 p-2 rounded-full text-white transition-colors border border-white/10"
          >
            <X className="w-4 h-4" />
          </button>
        )}
      </div>

      <div className="p-6">
        <div className="flex justify-between items-start mb-4">
          <div className="flex-1 min-w-0 pr-4">
            <h3 className="text-lg font-bold truncate group-hover:text-indigo-400 transition-colors">{post.title}</h3>
            <div className="flex items-center gap-2 mt-1">
              <span className="text-xs text-slate-500">@{post.authorName}</span>
              <span className="w-1 h-1 rounded-full bg-slate-700"></span>
              <span className="text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded-full font-bold border border-emerald-500/20 uppercase tracking-tighter">AI Verified</span>
            </div>
          </div>
          <button 
            onClick={(e) => {
              e.stopPropagation();
              onLike();
            }}
            className="flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-full hover:bg-rose-500/10 hover:text-rose-500 transition-all border border-transparent hover:border-rose-500/20"
          >
            <Heart className={`w-4 h-4 transition-transform active:scale-150 ${post.likes > 0 ? 'fill-rose-500 text-rose-500' : 'text-slate-500'}`} />
            <span className="font-bold text-sm">{post.likes}</span>
          </button>
        </div>
        <div className="flex items-center justify-between pt-4 border-t border-white/5">
           <div className="flex items-center gap-2">
              <div className="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
              <span className="text-[10px] font-mono text-slate-600 uppercase tracking-widest">Type: CodeShare 3D JSON</span>
           </div>
           <button className="text-slate-600 hover:text-indigo-400 transition-colors">
              <Share2 className="w-4 h-4" />
           </button>
        </div>
      </div>
    </div>
  );
}
